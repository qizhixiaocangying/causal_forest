## 基于因果森林的睡眠时长与代谢综合征风险关联异质性研究

**阶段一：项目定义与规划 (Project Definition and Planning)**

1.  1.1. 精确化研究问题与目标:

    -   明确研究问题：在美国成年人群中，异常（短或长）睡眠时长与代谢综合征(MetS)风险的关联是否因个体特征（尤其是体力活动水平和饮食质量）而异？
    -   设定可衡量的目标：
        -   

            (a) 估计不同睡眠时长组（短/长 vs. 正常）关联MetS风险的平均效应。

        -   

            (b) 估计该关联效应在不同个体特征组合下的条件平均处理效应(CATE)。

        -   

            (c) 识别并量化体力活动(PA)和饮食质量(DQ)对睡眠-MetS关联的调节作用（缓冲效应）。

        -   

            (d) 找出除PA和DQ外，其他显著影响睡眠-MetS关联异质性的协变量，包括入睡时间。

        -   

            (e) 探讨研究结果对个性化预防MetS的潜在指导意义。

2.  1.2. 确定目标NHANES周期与理由:

-   选择周期：使用2015-2016年度和2017-2018年度的NHANES调查周期。
    -   选择理由：选择这两个连续的两年周期以增加样本量，并确保研究时间范围覆盖2015年至2018年。确认这两个周期内关键变量的定义和测量方法具有一致性。

3.  1.3. 全面变量识别与操作化定义 (概念):

-   结局变量(Y):

    -   确定MetS的定义标准为NCEP ATP III。

        -   构成MetS的5个组分包括：腰围、甘油三酯、HDL-C、血压、空腹血糖，其在NHANES中的对应测量指标见阶段二的数据文件说明。

    -   处理每个组分临界值和药物使用的逻辑为：服用降压药者无论血压值如何均视为血压组分异常；糖尿病患者无论空腹血糖值如何均视为血糖组分异常；服用降血脂药物者需根据其适应症判断是否影响甘油三酯或HDL-C组分。

        -   最终使用二分类MetS状态（是/否）作为主要结局，并考虑将连续性MetS风险评分作为补充分析。

    -   处理变量(W):

        -   用于测量睡眠时长的NHANES问卷问题是关于通常每晚睡眠的小时数。
        -   睡眠时长的分类标准为：\<6小时为"短"，7-8小时为"正常/参照"，\>9小时为"长"。选择这些截点的依据来源于既往文献和临床意义。

    -   处理边界值（如正好6小时或9小时）时，将按照上述标准进行分类。缺失的睡眠数据将根据缺失比例和模式决定处理方法（如排除或插补）。

-   关键调节变量:

    -   体力活动(PA)：从PA问卷中提取活动类型、频率、时长、强度等信息。计算总体力活动量的方法为MET-分钟/周，具体计算方法参照NHANES指南。PA将作为连续变量进行初步分析，并考虑根据指南分类为"低/中/高"或"达标/未达标"进行敏感性分析。

        -   饮食质量(DQ)：计算DQ所依据的膳食数据来源于24小时膳食回顾。选择使用的膳食质量指数为HEI-2015。计算该指数的主要步骤包括食物编码映射、食物组分量计算、按HEI-2015标准评分。

    -   其他协变量(X):

        -   计划纳入模型的协变量清单包括：人口统计学（年龄、性别、种族、教育、收入）、人体测量（BMI）、生活方式（吸烟、饮酒）、健康状况（抑郁症状得分、基线慢性病史、肾功能eGFR）、**入睡时间**。

    -   每个协变量的潜在混杂作用或效应修饰作用理论依据如下：年龄、性别、种族、收入和教育可能影响生活方式和健康行为；BMI是MetS的重要危险因素；吸烟和饮酒与睡眠和代谢健康相关；抑郁症状和慢性病史可能与睡眠和MetS存在共同的病理机制；肾功能受损可能影响代谢和睡眠；**入睡时间可能反映了个体的昼夜节律，进而影响睡眠质量和代谢健康。**

        -   每个协变量的测量方式和单位（或分类方式）将在阶段二详细说明。**入睡时间将从睡眠问卷中提取，以小时或具体的几点几分记录，并根据需要转换为连续变量（如一天中的小时数）或分类变量（如早睡、正常、晚睡）。**

4.  1.4. 定义研究人群 (纳入/排除标准):

-   纳入标准包括：年龄范围≥20岁，参加了MEC检查，且提供了完整的睡眠时长数据。
    -   排除标准包括：孕妇，关键变量（定义MetS组分、体力活动、饮食质量）缺失者（除非采用合理的插补方法），以及可能需要排除的极端值数据点。排除孕妇是因为妊娠期生理变化可能影响代谢状态；关键变量缺失会直接影响模型构建；极端值可能由于测量误差或特殊情况导致，需要谨慎处理。

5.  1.5. 制定具体研究假设:
    -   H1 (异质性存在): 睡眠时长与MetS风险的关联强度（CATE）在不同个体特征(X)的人群中存在显著差异。
    -   H2 (调节/缓冲作用): 体力活动水平越高和/或饮食质量越好，异常睡眠时长（短/长）与MetS风险增加的关联强度越弱（即PA和DQ对负面效应有缓冲作用）。
    -   H3 (其他调节因素): 除了PA和DQ，其他因素（如年龄、BMI、**入睡时间**）也可能显著调节睡眠-MetS的关联。
6.  1.6. 制定数据管理计划:
    -   规划数据存储在安全的服务器上，并进行定期备份。
    -   建立详细的数据字典，记录所有变量的来源、定义、编码和处理步骤，包括**入睡时间的具体编码和处理方法**。
    -   制定清晰的文件命名规范，确保数据和分析脚本的可追溯性。
7.  1.7. 伦理考量:

-   确认使用公开去标识化的NHANES数据符合伦理要求，通常无需额外的伦理审查。在论文的方法部分将明确声明数据来源和伦理声明。

**阶段二：数据获取与准备 (概念性)**

1.  2.1. 识别必要的NHANES数据文件 (概念列表):
    -   基于阶段1.3的变量清单，需要下载的NHANES数据文件类别包括：DEMO, SLQ, BMX, BPX, TRIGLY, HDL, GLU, BIOPRO/CHEM, PAQ, SMQ, ALQ, DPQ, RXQ_RX, DRXTOT, DRXIFF等。
    -   对于2015-2016年度，所需文件名为DEMO_I, SLQ_I, BMX_I, BPX_I, L10_TRIGLY, L10_HDL, L10_GLU, L10_BIOPRO, PAQ_I, SMQ_I, ALQ_I, DPQ_I, RXQ_RX_I, DR1TOT_I, DR2TOT_I, DR1IFF_I, DR2IFF_I等（具体文件名以NHANES官方文档为准）。
    -   对于2017-2018年度，所需文件名为DEMO_J, SLQ_J, BMX_J, BPX_J, M11_TRIGLY, M11_HDL, M11_GLU, M11_BIOPRO, PAQ_J, SMQ_J, ALQ_J, DPQ_J, RXQ_RX_J, DR1TOT_J, DR2TOT_J, DR1IFF_J, DR2IFF_J等（具体文件名以NHANES官方文档为准）。
2.  2.2. 数据下载策略:
    -   计划通过NHANES网站手动下载所需的数据文件。
3.  2.3. 数据合并策略:

-   所有下载的文件都将使用参与者唯一标识符(SEQN)作为合并的主键。
    -   合并顺序为：首先在每个周期内合并所有相关文件，然后将2015-2016年度和2017-2018年度的数据集按行合并。

4.  2.4. 数据清洗策略:

-   缺失值处理:

    -   评估关键变量（Y, W, PA, DQ, 主要X，包括**入睡时间**）的缺失比例和模式。
        -   选择处理策略为多重插补(MICE)，以处理缺失数据并评估其对结果的影响。
    -   选择MICE的原因是其能考虑到缺失数据的随机性，提供更稳健的估计。将在敏感性分析中比较完整案例分析的结果。

-   异常值处理:

    -   对连续变量（如BMI、血压、实验室指标、**入睡时间**）设定基于生理学合理范围或分布（如3个标准差之外）的阈值来识别潜在异常值。
    -   处理异常值的方法为将超出阈值的值视为缺失值，并纳入到缺失值处理流程中。

5.  2.5. 详细变量构建计划 (逐步逻辑):

    -   MetS (Y):

    诊断标准：<https://en.wikipedia.org/wiki/Metabolic_syndrome#Diagnosis>

    1.  从相应的实验室和体检数据文件中提取腰围、甘油三酯、HDL-C、血压和空腹血糖的测量值。
    2.  从处方药数据文件中识别正在服用抗高血压、降糖或降脂药物的参与者。
    3.  根据NCEP ATP III标准，结合测量值和药物使用情况，判断每个MetS组分是否异常。
    4.  如果至少3个组分异常，则定义为MetS阳性，生成二分类变量。
    5.  （可选）计算满足异常标准的组分数，作为连续评分。

    -   Sleep Cat (W):

        1.  从睡眠问卷中提取关于通常每晚睡眠小时数的数据。
        2.  根据预设的分类标准（\<6小时为"短"，7-8小时为"正常/参照"，\>9小时为"长"）创建睡眠时长分类变量。

    -   PA (Moderator):

        1.  从体力活动问卷中提取所有相关的活动类型、频率、时长和强度信息。
        2.  使用NHANES官方指南或相关文献提供的MET值，计算每种活动的MET-分钟数。
        3.  将所有活动的MET-分钟数加总，得到每周总的MET-分钟数，作为连续的体力活动变量。

    -   DQ (Moderator):

        1.  从膳食数据文件中获取参与者两天的食物摄入详细信息。
        2.  使用USDA FNDDS数据库将食物编码映射到食物组。
        3.  计算每个参与者对HEI-2015各组分的摄入量。
        4.  根据HEI-2015的评分标准，计算每个组分的得分，并加总得到最终的HEI-2015总分。

    -   Covariates (X):

        1.  从人口统计学文件中提取年龄、性别、种族和教育程度信息。
        2.  从收入文件中提取家庭收入与贫困比信息。
        3.  基于身高和体重测量值计算BMI。
        4.  从吸烟和饮酒问卷中提取相关信息，创建吸烟和饮酒的分类变量。
        5.  计算PHQ-9总分，将DPQ010至DPQ090的得分相加。
        6.  使用CKD-EPI公式，结合血清肌酐、年龄、性别和种族信息计算eGFR。
        7.  **从睡眠问卷中提取关于就寝时间的问题（例如，询问通常几点睡觉）。将回答转换为24小时制的小时数（例如，晚上10点转换为22），作为连续变量。如果问题是分类的（例如，早睡、正常、晚睡），则直接使用该分类变量。**

6.  2.6. 创建最终分析数据集:

    -   整合所有清洗、构建好的变量（Y, W, X，包括**入睡时间**），以及对应的SEQN、权重、PSU和Strata变量。
    -   确保数据集的结构适合后续的统计分析软件，例如，分类变量已正确编码为因子变量。

**阶段三：探索性数据分析 (EDA) 计划**

1.  3.1. 描述性统计计划 (加权):
    -   使用正确的调查权重，计算研究样本的基本特征：
        -   人口统计学、生活方式、健康状况变量（包括**入睡时间**）的加权均值/标准差（连续变量）或频率/百分比（分类变量）。
        -   分别在不同睡眠时长组(W)中报告这些特征，以观察组间差异。
        -   报告结局变量(Y)的加权分布（如MetS患病率）。
2.  3.2. 数据可视化计划 (加权):
    -   使用加权方法绘制图表：
        -   关键连续变量（如年龄、BMI、DQ评分、**入睡时间**）的分布图（直方图、密度图）。
        -   结局变量(Y)在不同睡眠时长组(W)中的分布（如箱线图、条形图）。
        -   关键调节变量（PA、DQ）与睡眠时长(W)的关系（如箱线图）。
        -   初步观察协变量(X)（包括**入睡时间**）与结局(Y)的关系。
3.  3.3. 协变量平衡性检查计划:
    -   比较不同睡眠时长组(W)之间关键协变量(X)（包括**入睡时间**）的加权均值或比例。计算标准化平均差(SMD)来量化组间差异。较大的SMD提示潜在的混杂。
4.  3.4. 重叠性/正值性评估计划:
    -   检查在协变量(X)（包括**入睡时间**）的不同取值范围内，是否都存在属于不同睡眠时长组(W)的个体。
    -   可通过可视化（如倾向得分的重叠图，如果计算了倾向得分的话）或检查协变量在各组中的分布范围来初步评估。识别是否存在重叠性可能较差的区域。

**阶段四：因果推断框架与建模计划**

1.  4.1. 陈述因果假设与理由:
    -   明确陈述SUTVA（稳定单元处理价值假设）、Unconfoundedness（无混杂性/条件可忽略性）和Positivity（正值性/重叠性）这三个核心假设。
    -   为"无混杂性"提供论证：说明所纳入的协变量X集合（包括**入睡时间**）为何被认为是足够丰富的，能够控制住睡眠时长(W)与MetS(Y)之间的主要共同原因。承认可能存在的未测量混杂。
    -   基于EDA的结果，评估"重叠性"假设是否大致满足。
2.  4.2. 因果森林模型设定计划:
    -   确定模型输入：Y（MetS结局），W（睡眠时长分类），X（包含PA、DQ、**入睡时间**及所有其他协变量的矩阵）。
    -   确认W是分类变量时，模型将进行一系列相对于参照组（正常睡眠）的二分类比较。
3.  4.3. 选择因果森林软件/包 (概念):
    -   确定将使用R语言和grf包来实现因果森林。
4.  4.4. 模型训练计划 (概念):
    -   描述模型训练的核心机制：集成多棵树、随机抽样（自助法、特征子集）、**诚实估计**（分离分裂样本和估计样本）、**异质性最大化分裂准则**。
    -   明确模型将使用grf包的内置功能整合**调查权重**和**聚类/分层信息**（通过指定`sample.weights`和`clusters`参数），以获得正确的点估计和标准误。
5.  4.5. 参数调优策略 (如适用):
    -   初步计划使用grf包的默认参数进行模型训练，因为该包的默认参数通常表现良好。如果需要，将考虑使用交叉验证等方法对超参数（如树的数量、节点最小样本量）进行调优。
6.  4.6. CATE估计计划:
    -   说明训练好的模型将为每个个体（或具有特定特征x的个体）输出一个CATE估计值 τ̂(x)，代表异常睡眠时长相对于正常睡眠时长的（条件平均）效应。

**阶段五：结果分析与解读计划**

1.  5.1. 分析平均效应 (ATE/平均CATEs):
    -   计算并报告每个比较（如短vs正常，长vs正常）的加权平均CATE及其置信区间。
2.  5.2. 分析CATE分布 (异质性评估):
    -   绘制每个比较的CATE估计值 τ̂(x) 的加权直方图或密度图。
    -   评估分布的形状、中心、离散程度（方差）。方差越大，异质性越显著。
3.  5.3. 识别异质性驱动因素 (变量重要性):
    -   计算并可视化因果森林提供的"变量重要性"度量，该度量衡量每个协变量X（包括**入睡时间**）对**解释CATE变异**的贡献。
    -   识别最重要的几个驱动因素（预期PA, DQ, BMI, 年龄, **入睡时间**等可能排在前列）。
4.  5.4. 可视化CATE vs. 关键调节变量:
    -   绘制CATE估计值 τ̂(x) 与关键调节变量（PA水平、DQ分数）以及其他重要驱动因素（如BMI、年龄、**入睡时间**）的散点图或箱线图（对分类变量）。
    -   使用加权平滑曲线（如loess）观察趋势，以评估是否存在调节效应（例如，τ̂(x) 是否随PA增加而减小？τ̂(x) 是否随**入睡时间**的推后而增大？）。
5.  5.5. 数据驱动的子群分析计划:
    -   使用方法（如grf包的`best_linear_projection`）拟合一个简单的线性模型来预测CATE，以总结异质性的主要模式。
    -   或者，根据CATE估计值将人群分层（如分为效应最强/中等/最弱的四分位数组），然后比较这些组在关键协变量（PA, DQ, BMI, Age, **入睡时间**等）上的特征差异。
6.  5.6. 结果解读框架:
    -   结合领域知识（睡眠、代谢、运动、营养）和关于昼夜节律的知识，解释观察到的异质性模式和调节效应。
    -   讨论这些发现对理解睡眠与代谢健康关系的意义，以及**入睡时间**在其中的作用。

**阶段六：Cox 模型验证计划**

1.  6.1. 构建生存分析数据集:
    -   由于NHANES是横断面调查，直接进行标准的生存分析（需要事件发生时间和状态）存在局限性。然而，可以**概念性地**将MetS的患病状态作为终点事件（虽然不是真正的"发生"时间）。

    -   为了进行验证，可以考虑以下方法（需要在讨论部分明确指出此方法的局限性）：

        -   将研究人群按照基线（2015-2018年）的睡眠时长分类作为主要预测因子。
        -   将MetS状态（是/否）作为Cox模型的"事件"。
        -   **注意：由于缺乏随访时间信息，这里的时间变量需要进行特殊处理。一种方法是假设所有参与者的随访时间相同，但这会弱化Cox模型的解释力。另一种方法是如果NHANES数据中包含后续的调查轮次信息，可以尝试追踪个体MetS状态的变化（但这超出了当前提供的周期范围）。**
        -   纳入在因果森林模型中使用的相同协变量（包括**入睡时间**）。
2.  6.2. Cox 模型设定:
    -   使用睡眠时长分类（短/长 vs. 正常）作为主要预测变量。
    -   将MetS状态作为二分类结局变量。
    -   纳入年龄、性别、种族、教育、收入、BMI、吸烟状况、饮酒量、抑郁症状得分、肾功能eGFR、体力活动、饮食质量和**入睡时间**作为协变量进行调整。
3.  6.3. 选择Cox模型软件/包 (概念):
    -   使用R语言的survival包进行Cox比例风险模型分析。
4.  6.4. 模型训练与结果解释:
    -   使用调查权重和抽样设计信息拟合加权的Cox模型。
    -   报告睡眠时长各组相对于正常睡眠组的风险比(Hazard Ratio, HR)及其95%置信区间。
    -   解释HR的意义：HR\>1表示风险增加，HR\<1表示风险降低。
5.  6.5. 验证策略:
    -   比较Cox模型中睡眠时长与MetS风险的关联方向和显著性与因果森林模型中ATE的估计结果是否一致。
    -   考察在调整了相同协变量后，睡眠时长对MetS风险的独立预测作用是否仍然显著。
    -   **强调**: 由于NHANES数据的横断面性质，此处的Cox模型更多的是检验基线睡眠时长与基线MetS状态的关联，而非预测MetS的发生风险。这与因果森林估计的平均处理效应在方向上进行比较，以增强研究结果的稳健性。
